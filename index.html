<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SARG IA - Sistema de Análise da Roda da Gestão</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #e67e22; --bg-light: #f8f9fa; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', system-ui, sans-serif; color: #333; }
        
        .app-header { background: linear-gradient(135deg, var(--primary) 0%, #1a252f 100%); color: white; padding: 40px 0; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .upload-container { border: 2px dashed #bdc3c7; border-radius: 15px; background: white; padding: 40px; text-align: center; transition: all 0.3s ease; cursor: pointer; }
        .upload-container:hover { border-color: var(--primary); background: #ecf0f1; transform: translateY(-2px); }
        
        .ai-card { border: 2px solid var(--accent); }
        .ai-header { background: linear-gradient(45deg, #d35400, #e67e22); color: white; padding: 15px; font-weight: bold; }
        .ai-content { padding: 25px; font-size: 0.95em; line-height: 1.6; background: #fff; }
        
        .insight-box { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #ddd; }
        .insight-box:last-child { border-bottom: none; padding-bottom: 0; }
        .insight-title { color: var(--accent); font-weight: 800; text-transform: uppercase; font-size: 0.85em; letter-spacing: 1px; margin-bottom: 5px; }
        
        .kpi-card { background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: none; margin-bottom: 20px; overflow: hidden; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 700; margin: 0 auto 15px; border: 8px solid #eee; }
        .priority-badge { width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; color: white; }
        .p-high { background-color: #2980b9; } .p-med { background-color: #f39c12; } .p-low { background-color: #c0392b; }
        
        .refresh-btn { position: fixed; bottom: 30px; right: 30px; border-radius: 50px; padding: 15px 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 1000; }
        .refresh-book-btn { border: none; background: transparent; color: var(--primary); cursor: pointer; transition: transform 0.2s; }
        .refresh-book-btn:hover { transform: rotate(180deg); color: var(--accent); }
    </style>
</head>
<body>

<div class="app-header text-center">
    <div class="container">
        <h1 class="fw-bold"><i class="fas fa-network-wired me-2"></i>SARG <span class="badge bg-light text-dark fs-6 align-middle">IA</span></h1>
        <p class="lead opacity-75 mb-0">Sistema de Análise da Roda da Gestão</p>
    </div>
</div>

<div class="container pb-5">
    <div id="uploadSection" class="row justify-content-center">
        <div class="col-md-8">
            <div class="upload-container" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt fa-4x text-muted mb-3"></i>
                <h3 class="fw-bold text-secondary">Carregar Planilha de Diagnóstico</h3>
                <p class="text-muted">Selecione o arquivo .xlsx ou .csv da Roda da Gestão</p>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleFile(this)">
            </div>
            <div class="text-center mt-3 text-success">
                <i class="fas fa-check-circle me-1"></i> Consultor IA Integrado
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="kpi-card p-4 text-center h-100">
                    <h6 class="text-uppercase text-muted mb-3">Índice Geral de Gestão</h6>
                    <div id="scoreCircle" class="score-circle">0.0</div>
                    <div id="scoreStatus" class="badge bg-secondary fs-6 px-3 py-2 rounded-pill">Calculando...</div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="kpi-card ai-card h-100 p-0">
                    <div class="ai-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-brain me-2"></i>Consultor Estratégico (IA)</span>
                        <span class="badge bg-white text-dark" style="font-size:0.7em">ANÁLISE DE CLUSTER</span>
                    </div>
                    <div id="logicOutput" class="ai-content"></div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-5">
                <div class="kpi-card p-4 h-100">
                    <h5 class="fw-bold mb-4">Radar de Competências</h5>
                    <div style="height: 350px; position: relative;"><canvas id="radarChart"></canvas></div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="kpi-card p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold text-danger"><i class="fas fa-clipboard-list me-2"></i>Plano de Ação Prioritário</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="regeneratePlan()" title="Gerar novas sugestões"><i class="fas fa-sync-alt"></i> Variar Estratégias</button>
                    </div>
                    <div id="actionPlanContainer" style="max-height: 500px; overflow-y: auto; padding-right: 10px;"></div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="kpi-card p-4">
                    <h5 class="fw-bold text-dark mb-4"><i class="fas fa-book-reader me-2"></i>Matriz de Desenvolvimento & Literatura</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th style="width: 30%">Ponto Crítico</th><th class="text-center" style="width: 15%">Prioridade (0-5)</th><th style="width: 25%">Ferramenta Sugerida</th><th style="width: 30%">Literatura Recomendada <small class="text-muted fw-normal">(Clique p/ variar)</small></th></tr></thead>
                            <tbody id="developmentTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="kpi-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold text-primary"><i class="fas fa-chart-line me-2"></i>Histórico de Evolução (Últimas 4 Análises)</h5>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearHistory()"><i class="fas fa-trash me-2"></i>Limpar Histórico</button>
                    </div>
                    <div style="height: 350px; position: relative;">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                    <p id="evolutionText" class="text-muted small text-center mt-3">Carregue novas planilhas periodicamente para ver a linha do tempo.</p>
                </div>
            </div>
        </div>
        
        <button class="btn btn-primary refresh-btn" onclick="location.reload()"><i class="fas fa-upload me-2"></i>Nova Planilha</button>
    </div>
</div>

<script>
    // --- 1. GESTÃO DE HISTÓRICO E GRÁFICO DE TENDÊNCIA ---
    function processHistory(currentData) {
        // Calcular médias atuais por pilar
        const currentScores = {};
        currentData.forEach(d => {
            // Normaliza nomes de categoria para garantir que 'MERCADO' e 'CONHECIMENTO DE MERCADO' sejam a mesma chave
            let k = d.category.replace("GESTÃO DE ", "").replace("CONHECIMENTO DE ", "").replace("CONHECIMENTO DO ", "").trim();
            // Mapeamento extra para garantir chaves consistentes
            if(k.includes("MERCADO")) k = "MERCADO";
            else if(k.includes("EQUIPE")) k = "EQUIPE";
            else if(k.includes("PLANEJAMENTO")) k = "PLANEJAMENTO";
            else if(k.includes("INOVAÇÃO") || k.includes("INOVACAO")) k = "INOVACAO";
            else if(k.includes("INDICADORES")) k = "INDICADORES";
            else k = "DIRECIONAMENTO";

            if(!currentScores[k]) currentScores[k] = {sum:0, count:0};
            currentScores[k].sum += d.score;
            currentScores[k].count++;
        });

        const currentAverages = {};
        Object.keys(currentScores).forEach(key => {
            currentAverages[key] = parseFloat((currentScores[key].sum / currentScores[key].count).toFixed(1));
        });

        // Recuperar Histórico (Usando nova chave 'trend_v2' para isolar versões)
        const historyKey = 'sarg_trend_v2';
        let history = JSON.parse(localStorage.getItem(historyKey) || '[]');

        // Adiciona a análise atual com data simplificada
        const today = new Date();
        const dateStr = today.getDate().toString().padStart(2, '0') + '/' + (today.getMonth()+1).toString().padStart(2, '0') + ' ' + today.getHours() + ':' + today.getMinutes().toString().padStart(2,'0');
        
        history.push({ date: dateStr, scores: currentAverages });

        // Mantém apenas as últimas 4 (FIFO)
        if (history.length > 4) {
            history = history.slice(history.length - 4);
        }

        // Salva e Renderiza
        localStorage.setItem(historyKey, JSON.stringify(history));
        renderTrendChart(history);
    }

    function renderTrendChart(history) {
        const ctx = document.getElementById('evolutionChart').getContext('2d');
        
        // Eixo X: Datas
        const labels = history.map(h => h.date);

        // Identificar Pilares (Keys) presentes na última análise
        // (Assumimos que os pilares não mudam drasticamente entre planilhas)
        const sampleScores = history[history.length-1].scores;
        const pillars = Object.keys(sampleScores);

        // Cores fixas para consistência visual
        const colors = {
            'MERCADO': '#3498db',      // Azul
            'DIRECIONAMENTO': '#2ecc71', // Verde
            'PLANEJAMENTO': '#f1c40f', // Amarelo
            'EQUIPE': '#9b59b6',       // Roxo
            'INOVACAO': '#e74c3c',     // Vermelho
            'INDICADORES': '#34495e'   // Cinza Escuro
        };

        // Montar Datasets (Linhas)
        const datasets = pillars.map(pilar => ({
            label: pilar,
            data: history.map(h => h.scores[pilar] || null), // Null se não houver dado naquele dia
            borderColor: colors[pilar] || '#95a5a6',
            backgroundColor: colors[pilar] || '#95a5a6',
            borderWidth: 3,
            tension: 0.3, // Curvatura suave
            pointRadius: 5,
            pointHoverRadius: 7,
            fill: false
        }));

        if(window.evolutionChartInstance) window.evolutionChartInstance.destroy();

        window.evolutionChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        max: 10,
                        title: { display: true, text: 'Nota (0-10)' }
                    }
                },
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y;
                            }
                        }
                    }
                }
            }
        });
        
        // Atualiza texto informativo
        document.getElementById('evolutionText').innerHTML = `Mostrando a evolução das <strong>${history.length}</strong> últimas análises.`;
    }

    function clearHistory() {
        if(confirm("Tem certeza? Isso apagará o histórico das últimas análises.")) {
            localStorage.removeItem('sarg_trend_v2');
            alert("Histórico limpo.");
            location.reload();
        }
    }

    // --- 2. CLUSTER INTELLIGENCE ENGINE (MANTIDO) ---
    function runClusterAnalysis(data) {
        const output = document.getElementById('logicOutput');
        const criticalCluster = data.filter(d => d.score < 7).sort((a,b) => a.score - b.score);
        const strongCluster = data.filter(d => d.score >= 8).sort((a,b) => b.score - a.score);
        
        let diagnosisTitle = "", diagnosisText = "", leverageText = "", mentorText = "";

        if (criticalCluster.length === 0) {
            diagnosisTitle = "Excelência Operacional";
            diagnosisText = "Sua gestão está sólida, sem pontos críticos evidentes. O desafio agora não é correção, mas inovação. O risco é o acomodamento.";
            leverageText = "Foque em replicar o sucesso do item <strong>" + (strongCluster[0]?.item || "Gestão") + "</strong> para outras áreas da empresa.";
            mentorText = "O topo da montanha é onde venta mais forte. Mantenha a vigilância.";
        } 
        else if (criticalCluster.length >= 5) {
            const worst3 = criticalCluster.slice(0,3).map(i => `<strong>${i.item}</strong> (${i.score})`).join(", ");
            diagnosisTitle = "Sobrecarga Sistêmica";
            diagnosisText = `Detectamos múltiplos pontos de fragilidade simultâneos. Os gargalos mais severos estão em: ${worst3}. Tentar resolver tudo ao mesmo tempo levará à exaustão.`;
            leverageText = `Esqueça os outros problemas por 7 dias. Foque 100% da sua energia apenas em estancar a sangria de <strong>${criticalCluster[0].item}</strong>.`;
            mentorText = "Quem caça dois coelhos não pega nenhum. Escolha uma batalha e vença.";
        }
        else {
            const worstItem = criticalCluster[0];
            const secondWorst = criticalCluster.length > 1 ? criticalCluster[1] : null;
            diagnosisTitle = `Atenção: ${worstItem.category}`;
            
            if (secondWorst) {
                if (worstItem.category === secondWorst.category) {
                    diagnosisText = `Colapso localizado no pilar <strong>${worstItem.category}</strong>. Os itens <strong>${worstItem.item}</strong> e <strong>${secondWorst.item}</strong> estão ambos abaixo do esperado. Falha estrutural de processo nesta área.`;
                    leverageText = `Revisão de Processo em ${worstItem.category}. Agende uma reunião de imersão apenas sobre este tema.`;
                } else {
                    diagnosisText = `Efeito Dominó: A falha em <strong>${worstItem.item}</strong> (${worstItem.category}) está provavelmente contaminando <strong>${secondWorst.item}</strong> (${secondWorst.category}).`;
                    leverageText = `Ação em Cadeia: Ao resolver <strong>${worstItem.item}</strong>, você naturalmente destravará <strong>${secondWorst.item}</strong>. Foque no primeiro.`;
                }
            } else {
                diagnosisText = `Sua gestão é sólida, exceto por um ponto cego perigoso: <strong>${worstItem.item}</strong>. É ele que está impedindo seu salto de patamar.`;
                leverageText = `Intervenção Cirúrgica: Dedique tempo pessoal para mentoria ou redesenho deste item específico sem parar a operação.`;
            }
            const mentorPool = ["Não deixe o urgente matar o importante.", `Se você melhorar ${worstItem.item} em 10%, o impacto no todo será desproporcional.`, "Priorize ou paralise.", "Onde há fumaça, há fogo nos indicadores."];
            mentorText = mentorPool[Math.floor(Math.random() * mentorPool.length)];
        }

        output.innerHTML = `
            <div class="insight-box"><div class="insight-title"><i class="fas fa-stethoscope me-2"></i>DIAGNÓSTICO: ${diagnosisTitle}</div><p class="mb-0 text-secondary">${diagnosisText}</p></div>
            <div class="insight-box"><div class="insight-title"><i class="fas fa-bolt me-2"></i>AÇÃO DE ALAVANCA</div><p class="mb-0 text-secondary">${leverageText}</p></div>
            <div class="insight-box border-0 pb-0"><div class="insight-title"><i class="fas fa-user-tie me-2"></i>CONSELHO DO MENTOR</div><p class="mb-0 text-muted fst-italic">"${mentorText}"</p></div>
        `;
    }

    // --- BASE DE CONHECIMENTO V.2 ---
    const KNOWLEDGE_BASE = {
        "MERCADO": {
            keywords: ["MERCADO", "CONCORRENTE", "PROPOSTA", "VALOR", "SWOT", "REGIÃO", "MAPA"],
            tool: "Matriz de Competitividade / Mapa de Calor Regional",
            books: { level1: ["A Bíblia de Vendas (Gitomer)", "Marketing de Guerrilha (Levinson)"], level2: ["Posicionamento (Al Ries)", "Oceano Azul (Kim)"], level3: ["Competindo pelo Futuro (Hamel)", "Marketing 5.0 (Kotler)"] },
            actions: ["Mapeamento de Clusters: Identifique onde há densidade econômica.", "Matriz de Concorrência: Analise 'Win/Loss' para ajustar o discurso.", "Visitas Estratégicas: Visite para antecipar Churn ou Expansão.", "Rede de Influência: Mapeie contadores e parceiros locais.", "Roteiro Otimizado: Defina critérios objetivos de cobertura.", "Comunicação de Valor: Teste seu pitch com cliente de confiança."]
        },
        "DIRECIONAMENTO": {
            keywords: ["DIRECIONAMENTO", "CLAREZA", "FOCO", "MIX", "MCI", "RUMO"],
            tool: "Golden Circle / Matriz Eisenhower / Painel de Metas",
            books: { level1: ["Comece pelo Porquê (Sinek)", "Essencialismo (McKeown)"], level2: ["Empresas Feitas para Vencer (Collins)", "Princípios (Dalio)"], level3: ["A Arte da Estratégia (Dixit)", "Estratégia Competitiva (Porter)"] },
            actions: ["Venda Interna: Faça roleplay com o time sobre a proposta de valor.", "Gestão do Mix: Audite a carteira para reduzir dependência.", "Contas-Alvo: Defina nominalmente os clientes da semana.", "Painel de Rota: Mostre visualmente o que falta para a meta.", "Clareza de Resultado: Traduza meta mensal em ações diárias.", "Ajuste de Rumo: Proponha mudanças regionais estruturadas."]
        },
        "PLANEJAMENTO": {
            keywords: ["PLANEJAMENTO", "AÇÃO", "AGENDA", "ROTINA", "SEMANAL"],
            tool: "5W2H / Tríade do Tempo / Agenda Blocada",
            books: { level1: ["A Tríade do Tempo (Barbosa)", "GTD (Allen)"], level2: ["Execução (Charan)", "O Lado Difícil (Horowitz)"], level3: ["A Meta (Goldratt)", "Thinking in Systems (Meadows)"] },
            actions: ["Ritual Semanal: Formalize o plano da semana antes dela começar.", "Checkpoints Fixos: Dias específicos para medir planejado x realizado.", "Leading Indicators: Ligue ações a indicadores que antecipam a meta.", "Gestão de Reunião: Ferramentas de decisão, não eventos sociais.", "Análise de Impacto: Classifique ações por prazo.", "Backlog Regional: Lista de oportunidades com data."]
        },
        "EQUIPE": {
            keywords: ["EQUIPE", "FEEDBACK", "TREINAMENTO", "LIDERANÇA", "ALINHAMENTO", "PERFIL"],
            tool: "Feedback Canvas / Matriz Skill vs Will / PDI",
            books: { level1: ["O Monge e o Executivo (Hunter)", "Como Fazer Amigos (Carnegie)"], level2: ["Pipeline de Liderança (Charan)", "Drive (Pink)"], level3: ["Inteligência Emocional (Goleman)", "O Jogo Infinito (Sinek)"] },
            actions: ["Seleção por Perfil: Valide aderência ao cargo, não tape buraco.", "Treino de Sexta: Simulações de negociação e fechamento.", "Gestão de Campo: Acompanhe a equipe na rua.", "Feedback Disciplinar: Corrija desvios imediatamente.", "Rituais Separados: Não misture alinhamento com 1:1.", "PDCA de Erros: Use falhas como estudo de caso."]
        },
        "INOVACAO": {
            keywords: ["INOVAÇÃO", "PROJETOS", "NOVOS", "NEGÓCIOS", "TESTES"],
            tool: "PDCA / Design Thinking / Piloto Controlado",
            books: { level1: ["Roube Como um Artista (Kleon)", "Mindset (Dweck)"], level2: ["A Startup Enxuta (Ries)", "Sprint (Knapp)"], level3: ["O Dilema da Inovação (Christensen)", "De Zero a Um (Thiel)"] },
            actions: ["Líder Piloto: Teste pessoalmente antes de cobrar.", "Venda o Porquê: Garanta que o time entenda a razão da inovação.", "Piloto Controlado: Testes em pequena escala.", "Novos Negócios: Pipeline para parcerias e canais.", "Gestão de Fricção: Acompanhe a 'curva de aprendizado'.", "Feedback para Matriz: Traga dados reais do campo."]
        },
        "INDICADORES": {
            keywords: ["INDICADORES", "DASHBOARD", "NUMEROS", "FUNIL", "CANCELAMENTO", "POS-VENDA"],
            tool: "Gestão à Vista / CRM / Análise de Coorte",
            books: { level1: ["Receita Previsível (Ross)", "Gestão do Amanhã (Magaldi)"], level2: ["OKRs (Doerr)", "High Output Management (Grove)"], level3: ["KPIs (Parmenter)", "Antifrágil (Taleb)"] },
            actions: ["Gestão de Funil: Identifique gargalos por etapa.", "Tratativa de HOTs: Atue no fechamento das críticas.", "Autópsia de Churn: Documente causa raiz de cancelamentos.", "Tolerância Zero: Implacável com perdas operacionais.", "Projeção Semanal: Ajuste rota baseado na tendência matemática.", "Gestão à Vista: Equipe deve saber números de cabeça."]
        }
    };

    // --- FUNÇÕES DE PROCESSAMENTO E RENDERIZAÇÃO ---
    let GLOBAL_DATA = null;
    let GLOBAL_WEAKNESSES = [];

    function handleFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            processData(jsonData);
        };
        reader.readAsArrayBuffer(file);
    }

    function processData(rows) {
        const extractedData = [];
        let currentCategory = "";
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            if(!row || row.length < 2) continue;
            let item = row[1];
            let scoreRaw = row[2];
            if (!item) continue;
            if (row[0] && typeof row[0] === 'string' && row[0].trim().length > 2) { currentCategory = row[0].trim(); }
            if (scoreRaw !== undefined && scoreRaw !== null) {
                let score = parseFloat(scoreRaw);
                if (!isNaN(score) && score >= 0 && score <= 10 && item !== "ITENS AVALIADOS") {
                    extractedData.push({ category: currentCategory || "Geral", item: item, score: score });
                }
            }
        }
        if (extractedData.length > 0) {
            GLOBAL_DATA = extractedData;
            renderDashboard(extractedData);
            runClusterAnalysis(extractedData);
            processHistory(extractedData); // Histórico v15
        } else {
            alert("Erro: Não foi possível identificar dados válidos.");
        }
    }

    function renderDashboard(data) {
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        const totalScore = data.reduce((acc, curr) => acc + curr.score, 0);
        const avg = (totalScore / data.length).toFixed(1);
        const circle = document.getElementById('scoreCircle');
        circle.innerText = avg;
        let color = avg >= 8 ? '#27ae60' : (avg >= 6 ? '#f39c12' : '#c0392b');
        circle.style.borderColor = color; circle.style.color = color;
        document.getElementById('scoreStatus').innerText = avg >= 8 ? "Alta Performance" : (avg >= 6 ? "Em Desenvolvimento" : "Crítico");
        document.getElementById('scoreStatus').style.backgroundColor = color;
        const sortedData = [...data].sort((a, b) => a.score - b.score);
        GLOBAL_WEAKNESSES = sortedData.filter(d => d.score < 7);
        generateDevelopmentTable(GLOBAL_WEAKNESSES.length > 0 ? GLOBAL_WEAKNESSES : sortedData.slice(0, 5));
        generateActionPlan();
        renderChart(data);
    }

    function generateDevelopmentTable(items) {
        const tbody = document.getElementById('developmentTableBody');
        tbody.innerHTML = "";
        const sortedItems = items.sort((a,b) => b.score - a.score);
        sortedItems.forEach((item, index) => {
            let priority = Math.floor(item.score / 2);
            let badgeClass = priority >= 4 ? 'p-high' : (priority >= 2 ? 'p-med' : 'p-low');
            let kbKey = "DIRECIONAMENTO"; 
            const searchStr = (item.category + " " + item.item).toUpperCase();
            for (const key in KNOWLEDGE_BASE) { if (KNOWLEDGE_BASE[key].keywords.some(k => searchStr.includes(k))) { kbKey = key; break; } }
            let bookLevel = priority <= 1 ? "level1" : (priority >= 4 ? "level3" : "level2");
            const initialBook = KNOWLEDGE_BASE[kbKey].books[bookLevel][0];
            tbody.innerHTML += `<tr><td><div class="fw-bold">${item.item}</div><small class="text-muted">${item.category}</small></td><td class="text-center"><span class="priority-badge ${badgeClass}">${priority}</span></td><td><i class="fas fa-tools text-secondary me-2"></i>${KNOWLEDGE_BASE[kbKey].tool}</td><td><div class="d-flex align-items-center justify-content-between"><span id="book-${index}"><i class="fas fa-book text-secondary me-2"></i>${initialBook}</span><button class="refresh-book-btn" onclick="rotateBook('${kbKey}', '${bookLevel}', ${index})"><i class="fas fa-sync-alt"></i></button></div></td></tr>`;
        });
    }

    function rotateBook(kbKey, level, elementIndex) {
        const books = KNOWLEDGE_BASE[kbKey].books[level];
        const display = document.getElementById(`book-${elementIndex}`);
        let newBook = books[Math.floor(Math.random() * books.length)];
        let tries = 0; while (display.innerText.includes(newBook) && books.length > 1 && tries < 5) { newBook = books[Math.floor(Math.random() * books.length)]; tries++; }
        display.style.opacity = 0; setTimeout(() => { display.innerHTML = `<i class="fas fa-book text-secondary me-2"></i>${newBook}`; display.style.opacity = 1; }, 200);
    }

    function generateActionPlan() {
        const container = document.getElementById('actionPlanContainer');
        container.innerHTML = "";
        let targetItems = GLOBAL_WEAKNESSES.length > 0 ? GLOBAL_WEAKNESSES : GLOBAL_DATA.sort((a,b) => a.score - b.score).slice(0, 3);
        const groupedIssues = {};
        targetItems.forEach(item => { const cat = item.category || "GERAL"; if (!groupedIssues[cat]) groupedIssues[cat] = []; groupedIssues[cat].push(item); });
        Object.keys(groupedIssues).forEach(catName => {
            let kbKey = "DIRECIONAMENTO"; const searchStr = (catName + " " + groupedIssues[catName][0].item).toUpperCase();
            for (const key in KNOWLEDGE_BASE) { if (KNOWLEDGE_BASE[key].keywords.some(k => searchStr.includes(k))) { kbKey = key; break; } }
            const selectedActions = getRandomSubarray(KNOWLEDGE_BASE[kbKey].actions, 2);
            container.innerHTML += `<div class="mb-4 border-bottom pb-3"><div class="d-flex align-items-center mb-2"><span class="pillar-tag me-2">${kbKey}</span><h6 class="fw-bold mb-0 text-dark">Foco: ${groupedIssues[catName].map(i => i.item).slice(0,2).join(", ")}</h6></div><div class="bg-light p-3 rounded">${selectedActions.map(action => `<div class="action-step text-secondary small">${action}</div>`).join('')}</div></div>`;
        });
    }

    function getRandomSubarray(arr, size) {
        var shuffled = arr.slice(0), i = arr.length, min = i - size, temp, index;
        while (i-- > min) { index = Math.floor((i + 1) * Math.random()); temp = shuffled[index]; shuffled[index] = shuffled[i]; shuffled[i] = temp; }
        return shuffled.slice(min);
    }

    function regeneratePlan() {
        if(GLOBAL_DATA) {
            const btn = document.querySelector('button[title="Gerar novas sugestões"] i');
            btn.classList.add('fa-spin');
            setTimeout(() => { generateActionPlan(); btn.classList.remove('fa-spin'); }, 400);
        }
    }

    function renderChart(data) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        const catMap = {};
        data.forEach(d => { let k = d.category.replace("GESTÃO DE ", "").replace("CONHECIMENTO DE ", ""); if(!catMap[k]) catMap[k] = []; catMap[k].push(d.score); });
        const labels = Object.keys(catMap);
        const values = labels.map(k => catMap[k].reduce((a,b)=>a+b,0) / catMap[k].length);
        if(window.myRadar) window.myRadar.destroy();
        window.myRadar = new Chart(ctx, { type: 'radar', data: { labels: labels, datasets: [{ label: 'Performance', data: values, backgroundColor: 'rgba(211, 84, 0, 0.2)', borderColor: '#d35400', pointBackgroundColor: '#2c3e50', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { suggestedMin: 0, suggestedMax: 10 } } } });
    }
</script>
</body>
</html>