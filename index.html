<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SARG - Sistema de Análise da Roda da Gestão (AI Powered)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #e74c3c;
            --ai-color: #6c5ce7; /* Cor da IA */
            --bg-light: #f8f9fa;
        }
        
        body { background-color: #f4f7f6; font-family: 'Segoe UI', system-ui, sans-serif; color: #333; }
        
        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, #1a252f 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        /* Botão Config IA */
        .api-config-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px; padding: 5px 15px; font-size: 0.9em; cursor: pointer;
            transition: all 0.3s;
        }
        .api-config-btn:hover { background: white; color: var(--primary); }
        
        /* Upload Box */
        .upload-container {
            border: 2px dashed #bdc3c7;
            border-radius: 15px;
            background: white;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-container:hover {
            border-color: var(--primary);
            background: #ecf0f1;
            transform: translateY(-2px);
        }

        /* Cards */
        .kpi-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: none;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
        }

        /* Estilos Específicos IA */
        .ai-card { border: 2px solid var(--ai-color); }
        .ai-header { background: linear-gradient(45deg, #6c5ce7, #a29bfe); color: white; padding: 15px; font-weight: bold; }
        .ai-content { padding: 20px; font-size: 0.95em; line-height: 1.6; min-height: 150px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .ai-text { text-align: left; width: 100%; display: none; }
        .ai-text h1, .ai-text h2, .ai-text h3 { color: var(--ai-color); font-size: 1.1em; margin-top: 10px; font-weight: bold; }
        .ai-text ul { padding-left: 20px; }
        
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 auto 15px;
            border: 8px solid #eee;
        }

        /* Action Plan Styling */
        .action-step {
            position: relative;
            padding-left: 20px;
            margin-bottom: 15px;
            border-left: 3px solid var(--primary);
        }
        .action-step::before {
            content: "•";
            position: absolute;
            left: -16px;
            top: 0px;
            color: var(--primary);
            font-size: 1.5em;
            background: white;
        }

        .pillar-tag {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            padding: 5px 10px;
            border-radius: 4px;
            background: #dfe6e9;
            color: #636e72;
        }

        /* Table Styling */
        .priority-badge {
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            color: white;
        }
        .p-high { background-color: #2980b9; } /* 4-5 */
        .p-med { background-color: #f39c12; }  /* 2-3 */
        .p-low { background-color: #c0392b; }  /* 0-1 */

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            border-radius: 50px;
            padding: 15px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .refresh-book-btn { border: none; background: transparent; color: var(--primary); cursor: pointer; transition: transform 0.2s; }
        .refresh-book-btn:hover { transform: rotate(180deg); color: var(--accent); }
    </style>
</head>
<body>

<div class="app-header text-center">
    <button class="api-config-btn" onclick="openConfig()"><i class="fas fa-cog me-2"></i>Configurar IA</button>
    <div class="container">
        <h1 class="fw-bold"><i class="fas fa-network-wired me-2"></i>SARG</h1>
        <p class="lead opacity-75 mb-0">Sistema de Análise da Roda da Gestão (AI Powered)</p>
    </div>
</div>

<div class="container pb-5">
    
    <div id="uploadSection" class="row justify-content-center">
        <div class="col-md-8">
            <div class="upload-container" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt fa-4x text-muted mb-3"></i>
                <h3 class="fw-bold text-secondary">Carregar Planilha de Diagnóstico</h3>
                <p class="text-muted">Selecione o arquivo .xlsx ou .csv da Roda da Gestão</p>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleFile(this)">
            </div>
            <div id="apiKeyAlert" class="alert alert-warning mt-3" style="display:none;">
                <i class="fas fa-exclamation-triangle me-2"></i><strong>Configuração Necessária:</strong> Para ativar os insights inteligentes, clique em "Configurar IA" no topo e adicione sua chave Gemini.
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="kpi-card p-4 text-center h-100">
                    <h6 class="text-uppercase text-muted mb-3">Índice Geral de Gestão</h6>
                    <div id="scoreCircle" class="score-circle">0.0</div>
                    <div id="scoreStatus" class="badge bg-secondary fs-6 px-3 py-2 rounded-pill">Calculando...</div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="kpi-card ai-card h-100 p-0">
                    <div class="ai-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-robot me-2"></i>Consultor IA (Gemini)</span>
                        <span id="modelDisplay" class="badge bg-white text-primary" style="font-size:0.7em">PRONTO</span>
                    </div>
                    <div id="aiContentArea" class="ai-content">
                        <div id="aiInitialState" class="text-center">
                            <p class="text-muted mb-3">Clique para gerar insights estratégicos profundos sobre os dados.</p>
                            <button class="btn btn-primary" onclick="initiateAI()">
                                <i class="fas fa-magic me-2"></i>Gerar Análise IA
                            </button>
                        </div>
                        <div id="aiLoadingState" style="display:none;" class="text-center">
                            <i class="fas fa-circle-notch fa-spin fa-2x mb-3 text-primary"></i>
                            <p class="text-muted">Analisando padrões ocultos...</p>
                        </div>
                        <div id="aiResultState" class="ai-text"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-5">
                <div class="kpi-card p-4 h-100">
                    <h5 class="fw-bold mb-4">Radar de Competências</h5>
                    <div style="height: 350px; position: relative;">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="kpi-card p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold text-danger"><i class="fas fa-clipboard-list me-2"></i>Plano de Ação Prioritário</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="regeneratePlan()" title="Gerar novas sugestões"><i class="fas fa-sync-alt"></i> Variar Estratégias</button>
                    </div>
                    
                    <div id="actionPlanContainer" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                        </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-1">
            <div class="col-md-6">
                <div class="kpi-card p-4 border-start border-5 border-success">
                    <h6 class="text-success fw-bold text-uppercase"><i class="fas fa-check-circle me-2"></i>Pontos de Destaque</h6>
                    <ul id="strengthsList" class="list-group list-group-flush mt-3"></ul>
                </div>
            </div>
            <div class="col-md-6">
                <div class="kpi-card p-4 border-start border-5 border-danger">
                    <h6 class="text-danger fw-bold text-uppercase"><i class="fas fa-exclamation-triangle me-2"></i>Pontos Críticos</h6>
                    <ul id="weaknessesList" class="list-group list-group-flush mt-3"></ul>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="kpi-card p-4">
                    <h5 class="fw-bold text-dark mb-4"><i class="fas fa-book-reader me-2"></i>Matriz de Desenvolvimento & Literatura</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 30%">Ponto Crítico</th>
                                    <th class="text-center" style="width: 15%">Prioridade (0-5)</th>
                                    <th style="width: 25%">Ferramenta Sugerida</th>
                                    <th style="width: 30%">Literatura Recomendada <small class="text-muted fw-normal">(Clique p/ variar)</small></th>
                                </tr>
                            </thead>
                            <tbody id="developmentTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <button class="btn btn-primary refresh-btn" onclick="location.reload()">
            <i class="fas fa-upload me-2"></i>Nova Planilha
        </button>

    </div>
</div>

<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configuração de IA (Gemini)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">1. Chave de API</label>
                    <input type="password" id="apiKeyInput" class="form-control" placeholder="Cole sua chave aqui...">
                    <div class="form-text">Obtenha gratuitamente no <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>.</div>
                </div>
                
                <div class="d-grid gap-2 mb-3">
                     <button type="button" class="btn btn-warning" onclick="smartDetectModel()"><i class="fas fa-search me-2"></i>Detectar Modelo Compatível</button>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Modelo Detectado:</label>
                    <input type="text" id="modelSelect" class="form-control" readonly value="gemini-1.5-flash">
                </div>

                <div id="testResult" class="mt-2 small p-2 bg-light rounded" style="min-height:40px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveConfig()">Salvar & Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- LÓGICA SMART DISCOVERY IA (Detecta qual modelo a chave aceita) ---
    async function smartDetectModel() {
        const key = document.getElementById('apiKeyInput').value.trim();
        const resultDiv = document.getElementById('testResult');
        const modelInput = document.getElementById('modelSelect');
        
        if(!key) { resultDiv.innerHTML = "<span class='text-danger'>Insira uma chave primeiro.</span>"; return; }
        
        resultDiv.innerHTML = "<span class='text-primary'><i class='fas fa-spinner fa-spin'></i> Consultando Google API...</span>";
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            const data = await response.json();
            
            if(data.error) throw new Error(data.error.message);
            if(!data.models) throw new Error("Nenhum modelo encontrado.");

            const viableModels = data.models.filter(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent"));
            
            // Preferência: Flash -> Pro -> Outros
            const priorities = ['gemini-1.5-flash', 'gemini-1.5-flash-latest', 'gemini-1.5-pro', 'gemini-pro'];
            let chosenModel = viableModels.length > 0 ? viableModels[0].name : null;

            for (let pref of priorities) {
                const match = viableModels.find(m => m.name.includes(pref));
                if (match) { chosenModel = match.name; break; }
            }

            if(chosenModel) {
                const cleanModelName = chosenModel.replace('models/', '');
                modelInput.value = cleanModelName;
                resultDiv.innerHTML = `<span class='text-success fw-bold'><i class='fas fa-check-circle'></i> Sucesso! Encontramos: ${cleanModelName}</span>`;
            } else {
                throw new Error("Sua chave não tem acesso a modelos de texto.");
            }
            
        } catch(e) {
            resultDiv.innerHTML = `<span class='text-danger fw-bold'><i class='fas fa-times-circle'></i> Erro: ${e.message}</span>`;
        }
    }

    // --- CONFIGURAÇÃO ---
    function openConfig() {
        const myModal = new bootstrap.Modal(document.getElementById('configModal'));
        document.getElementById('apiKeyInput').value = localStorage.getItem('sarg_gemini_key') || '';
        document.getElementById('modelSelect').value = localStorage.getItem('sarg_gemini_model') || 'gemini-1.5-flash';
        myModal.show();
    }

    function saveConfig() {
        const key = document.getElementById('apiKeyInput').value.trim();
        const model = document.getElementById('modelSelect').value;
        if(key && model) {
            localStorage.setItem('sarg_gemini_key', key);
            localStorage.setItem('sarg_gemini_model', model);
            location.reload();
        } else {
            alert("Por favor, execute a detecção de modelo.");
        }
    }

    function checkApiKey() {
        if(!localStorage.getItem('sarg_gemini_key')) { document.getElementById('apiKeyAlert').style.display = 'block'; }
    }
    checkApiKey();

    // --- INTEGRAÇÃO GEMINI IA (ON DEMAND) ---
    async function initiateAI() {
        if(!GLOBAL_DATA) return;

        const apiKey = localStorage.getItem('sarg_gemini_key');
        let selectedModel = localStorage.getItem('sarg_gemini_model') || 'gemini-1.5-flash';
        
        // UI States
        document.getElementById('aiInitialState').style.display = 'none';
        document.getElementById('aiLoadingState').style.display = 'block';
        document.getElementById('aiResultState').style.display = 'none';
        document.getElementById('modelDisplay').innerText = "MODELO: " + selectedModel;

        if (!apiKey) {
            alert("Configure sua chave API primeiro.");
            document.getElementById('aiLoadingState').style.display = 'none';
            document.getElementById('aiInitialState').style.display = 'block';
            return;
        }

        // COMPRESSÃO DE DADOS (Envia apenas o essencial)
        const critical = GLOBAL_DATA.filter(d => d.score < 7).sort((a,b)=>a.score-b.score).slice(0, 10).map(d => `${d.item}: ${d.score}`);
        const strong = GLOBAL_DATA.filter(d => d.score >= 8).sort((a,b)=>b.score-a.score).slice(0, 3).map(d => `${d.item}: ${d.score}`);
        const summary = `Criticos: ${critical.join(", ")}. Fortes: ${strong.join(", ")}.`;
        
        const prompt = `Consultor Sênior em Gestão. Analise os dados: ${summary}. Retorne em Markdown: 1. Padrão Oculto (Correlação não óbvia). 2. Maior Risco. 3. Ação de Alavanca Imediata. Seja direto e estratégico.`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            if (response.status === 429) { throw new Error("Cota atingida (429). Aguarde 30s."); }

            const result = await response.json();
            if (result.error) throw new Error(`${result.error.message} (${result.error.code})`);
            
            if (result.candidates && result.candidates.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                const resultDiv = document.getElementById('aiResultState');
                resultDiv.innerHTML = marked.parse(text);
                
                document.getElementById('aiLoadingState').style.display = 'none';
                resultDiv.style.display = 'block';
            } else {
                throw new Error("Resposta vazia.");
            }
        } catch (error) {
            document.getElementById('aiLoadingState').style.display = 'none';
            document.getElementById('aiInitialState').style.display = 'block';
            alert(`Erro na IA: ${error.message}`);
        }
    }

    // --- BASE DE CONHECIMENTO ---
    const KNOWLEDGE_BASE = {
        "MERCADO": {
            keywords: ["MERCADO", "CONCORRENTE", "PROPOSTA", "VALOR", "SWOT"],
            tool: "Análise SWOT Cruzada / Matriz de Benchmarking",
            books: {
                level1: ["A Bíblia de Vendas (Jeffrey Gitomer)", "Marketing de Guerrilha (Jay C. Levinson)", "Vendas 3.0 (Sandro Magaldi)"],
                level2: ["Posicionamento (Al Ries & Jack Trout)", "A Estratégia do Oceano Azul (W. Chan Kim)", "O Ponto da Virada (Malcolm Gladwell)"],
                level3: ["Competindo pelo Futuro (Gary Hamel)", "Marketing 5.0 (Philip Kotler)", "Inovação e Espírito Empreendedor (Drucker)"]
            },
            actions: [
                "Mapeamento de Campo: Vá a campo na região para identificar ramos predominantes.",
                "Análise SWOT: Mapeie as ações dos concorrentes diretos e indiretos.",
                "Visitas Estratégicas: Visite os principais clientes para mapear redes de relacionamento.",
                "Comunicação de Valor: Teste seu pitch de vendas com um cliente de confiança."
            ]
        },
        "DIRECIONAMENTO": {
            keywords: ["DIRECIONAMENTO", "CLAREZA", "FOCO", "MIX", "MCI"],
            tool: "Golden Circle (Sinek) / Matriz Eisenhower",
            books: {
                level1: ["Comece pelo Porquê (Simon Sinek)", "O Poder do Hábito (Charles Duhigg)", "Essencialismo (Greg McKeown)"],
                level2: ["Empresas Feitas para Vencer (Jim Collins)", "Princípios (Ray Dalio)", "A Única Coisa (Gary Keller)"],
                level3: ["A Arte da Estratégia (Avinash K. Dixit)", "Estratégia Competitiva (Michael Porter)", "Medindo o Mundo (John Doerr)"]
            },
            actions: [
                "Venda Interna: Venda para sua equipe a proposta de valor antes do cliente.",
                "Mapa da Mina: Defina quais polos e ramos atacar na semana.",
                "Gestão do Mix: Diversifique a carteira para reduzir dependência.",
                "Clareza de Resultado: Defina O QUE e COMO atingir a meta."
            ]
        },
        "PLANEJAMENTO": {
            keywords: ["PLANEJAMENTO", "AÇÃO", "AGENDA", "ROTINA"],
            tool: "5W2H / Tríade do Tempo / Trello",
            books: {
                level1: ["A Tríade do Tempo (Christian Barbosa)", "GTD - A Arte de Fazer Acontecer (David Allen)", "Scrum (Jeff Sutherland)"],
                level2: ["O Lado Difícil das Situações Difíceis (Ben Horowitz)", "Execução (Ram Charan)", "Rápido e Devagar (Daniel Kahneman)"],
                level3: ["HBR - Gerenciamento de Projetos", "A Meta (Eliyahu M. Goldratt)", "Thinking in Systems (Donella Meadows)"]
            },
            actions: [
                "Disciplina Semanal: Check Point toda segunda-feira com a equipe.",
                "Visão Mensal: Status Report para alinhar gap do objetivo.",
                "MKT de Guerrilha: Ações rápidas e baratas para curto prazo.",
                "Checagem de Impacto: Valide se as ações geram resultado real."
            ]
        },
        "EQUIPE": {
            keywords: ["EQUIPE", "FEEDBACK", "TREINAMENTO", "LIDERANÇA", "ALINHAMENTO"],
            tool: "Feedback Canvas / Matriz Skill vs Will",
            books: {
                level1: ["O Monge e o Executivo (James C. Hunter)", "Como Fazer Amigos e Influenciar Pessoas (Dale Carnegie)", "Liderança Tóxica (Alaor Azevedo)"],
                level2: ["Pipeline de Liderança (Ram Charan)", "Drive (Daniel Pink)", "Preciso Saber se Estou Indo Bem (Richard L. Williams)"],
                level3: ["Liderança: A Inteligência Emocional (Daniel Goleman)", "Equipes Brilhantes (Daniel Coyle)", "O Jogo Infinito (Simon Sinek)"]
            },
            actions: [
                "Seleção de Perfil: Revise se as pessoas estão nas cadeiras certas.",
                "Investimento em Treino: Dedique tempo real ao desenvolvimento, não delegue tudo.",
                "Reuniões de Sexta: Roleplay de negociação e fechamento.",
                "Liderança pelo Exemplo: Acompanhe a equipe em campo."
            ]
        },
        "INOVACAO": {
            keywords: ["INOVAÇÃO", "PROJETOS", "NOVOS", "NEGÓCIOS"],
            tool: "PDCA / Design Thinking / Brainstorming",
            books: {
                level1: ["Roube Como um Artista (Austin Kleon)", "Mindset (Carol Dweck)", "Criatividade S.A. (Ed Catmull)"],
                level2: ["A Startup Enxuta (Eric Ries)", "Originais (Adam Grant)", "Sprint (Jake Knapp)"],
                level3: ["O Dilema da Inovação (Clayton Christensen)", "De Zero a Um (Peter Thiel)", "Organizações Exponenciais (Salim Ismail)"]
            },
            actions: [
                "Testes Práticos: Seja o piloto de novos conceitos antes da equipe.",
                "Buy-in da Equipe: Explique o 'porquê' das inovações.",
                "Feedback de Campo: Traga dados reais do mercado para a diretoria.",
                "Novos Negócios: Desenvolva relacionamento ativo com o mercado."
            ]
        },
        "INDICADORES": {
            keywords: ["INDICADORES", "DASHBOARD", "NUMEROS", "FUNIL", "CANCELAMENTO", "POS-VENDA"],
            tool: "Painel de Gestão à Vista / CRM",
            books: {
                level1: ["Receita Previsível (Aaron Ross)", "Gestão do Amanhã (Sandro Magaldi)", "A Venda Desafiadora (Matthew Dixon)"],
                level2: ["Avalie o que Importa - OKRs (John Doerr)", "Data Science para Negócios (Foster Provost)", "High Output Management (Andrew Grove)"],
                level3: ["KPIs: Key Performance Indicators (David Parmenter)", "Thinking in Bets (Annie Duke)", "Antifrágil (Nassim Taleb)"]
            },
            actions: [
                "Gestão por Números: Tolerância zero com falta de dados.",
                "Foco no Funil: Identifique onde está o gargalo (prospecção ou fechamento?).",
                "Tratativa de HOTs: Atue pessoalmente nos fechamentos difíceis.",
                "Análise de Churn: Entenda a causa raiz dos cancelamentos."
            ]
        }
    };

    let GLOBAL_DATA = null;
    let GLOBAL_WEAKNESSES = [];

    function handleFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            processData(jsonData);
        };
        reader.readAsArrayBuffer(file);
    }

    function processData(rows) {
        const extractedData = [];
        let currentCategory = "";

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            
            // Checks básicos para evitar linhas vazias
            if(!row || row.length < 2) continue;

            let category = row[0]; 
            let item = row[1];
            let scoreRaw = row[2];

            if (!item) continue;
            
            if (category && typeof category === 'string' && category.trim().length > 2) {
                currentCategory = category.trim();
            } else {
                category = currentCategory;
            }

            if (scoreRaw !== undefined && scoreRaw !== null) {
                let score = parseFloat(scoreRaw);
                if (!isNaN(score) && score >= 0 && score <= 10 && item !== "ITENS AVALIADOS") {
                    extractedData.push({
                        category: category || "Geral",
                        item: item,
                        score: score
                    });
                }
            }
        }

        if (extractedData.length > 0) {
            GLOBAL_DATA = extractedData;
            renderDashboard(extractedData);
        } else {
            alert("Erro: Não foi possível identificar dados válidos.");
        }
    }

    function renderDashboard(data) {
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';

        const totalScore = data.reduce((acc, curr) => acc + curr.score, 0);
        const avg = (totalScore / data.length).toFixed(1);
        
        const scoreCircle = document.getElementById('scoreCircle');
        scoreCircle.innerText = avg;
        
        let color, status;
        if (avg >= 8) { color = '#27ae60'; status = "Alta Performance"; }
        else if (avg >= 6) { color = '#f39c12'; status = "Em Desenvolvimento"; }
        else { color = '#c0392b'; status = "Crítico"; }
        
        scoreCircle.style.borderColor = color;
        scoreCircle.style.color = color;
        document.getElementById('scoreStatus').innerText = status;
        document.getElementById('scoreStatus').style.backgroundColor = color;

        const sortedData = [...data].sort((a, b) => a.score - b.score);
        GLOBAL_WEAKNESSES = sortedData.filter(d => d.score < 7);
        const strengths = sortedData.filter(d => d.score >= 8).reverse();

        updateLists(strengths, GLOBAL_WEAKNESSES);
        generateDevelopmentTable(GLOBAL_WEAKNESSES.length > 0 ? GLOBAL_WEAKNESSES : sortedData.slice(0, 5));
        generateActionPlan();
        renderChart(data);
    }

    function updateLists(strengths, weaknesses) {
        const createLi = (item, type) => `
            <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                <span>${item.item}</span>
                <span class="fw-bold ${type === 'good' ? 'text-success' : 'text-danger'}">${item.score}</span>
            </li>`;
            
        document.getElementById('strengthsList').innerHTML = strengths.slice(0, 5).map(i => createLi(i, 'good')).join('');
        document.getElementById('weaknessesList').innerHTML = weaknesses.slice(0, 5).map(i => createLi(i, 'bad')).join('') || '<li class="text-muted">Nenhum ponto crítico detectado.</li>';
    }

    // --- TABELA DE DESENVOLVIMENTO (SARG v4) ---
    function generateDevelopmentTable(items) {
        const tbody = document.getElementById('developmentTableBody');
        tbody.innerHTML = "";

        const sortedItems = items.sort((a,b) => b.score - a.score);

        sortedItems.forEach((item, index) => {
            let priority = Math.floor(item.score / 2);
            let badgeClass = priority >= 4 ? 'p-high' : (priority >= 2 ? 'p-med' : 'p-low');

            let kbKey = "DIRECIONAMENTO"; 
            const searchStr = (item.category + " " + item.item).toUpperCase();
            
            for (const key in KNOWLEDGE_BASE) {
                if (KNOWLEDGE_BASE[key].keywords.some(k => searchStr.includes(k))) {
                    kbKey = key;
                    break;
                }
            }

            let bookLevel = priority <= 1 ? "level1" : (priority >= 4 ? "level3" : "level2");
            const initialBook = KNOWLEDGE_BASE[kbKey].books[bookLevel][0];

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="fw-bold text-dark">${item.item}</div>
                    <small class="text-muted">${item.category}</small>
                </td>
                <td class="text-center">
                    <span class="priority-badge ${badgeClass}">${priority}</span>
                </td>
                <td><i class="fas fa-tools text-secondary me-2"></i>${KNOWLEDGE_BASE[kbKey].tool}</td>
                <td>
                    <div class="d-flex align-items-center justify-content-between">
                        <span id="book-${index}" class="text-dark"><i class="fas fa-book text-secondary me-2"></i>${initialBook}</span>
                        <button class="refresh-book-btn" onclick="rotateBook('${kbKey}', '${bookLevel}', ${index})" title="Variar livro">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- FUNÇÃO PARA RODAR LIVROS ---
    function rotateBook(kbKey, level, elementIndex) {
        const books = KNOWLEDGE_BASE[kbKey].books[level];
        const displayElement = document.getElementById(`book-${elementIndex}`);
        let newBook = books[Math.floor(Math.random() * books.length)];
        let tries = 0;
        while (displayElement.innerText.includes(newBook) && books.length > 1 && tries < 5) {
             newBook = books[Math.floor(Math.random() * books.length)];
             tries++;
        }
        displayElement.style.opacity = 0;
        setTimeout(() => {
            displayElement.innerHTML = `<i class="fas fa-book text-secondary me-2"></i>${newBook}`;
            displayElement.style.opacity = 1;
        }, 200);
    }

    function generateActionPlan() {
        const container = document.getElementById('actionPlanContainer');
        container.innerHTML = "";
        let targetItems = GLOBAL_WEAKNESSES.length > 0 ? GLOBAL_WEAKNESSES : GLOBAL_DATA.sort((a,b) => a.score - b.score).slice(0, 3);
        const groupedIssues = {};
        targetItems.forEach(item => {
            const cat = item.category || "GERAL";
            if (!groupedIssues[cat]) groupedIssues[cat] = [];
            groupedIssues[cat].push(item);
        });

        Object.keys(groupedIssues).forEach(catName => {
            let kbKey = "DIRECIONAMENTO"; 
            const searchStr = (catName + " " + groupedIssues[catName][0].item).toUpperCase();
            for (const key in KNOWLEDGE_BASE) {
                if (KNOWLEDGE_BASE[key].keywords.some(k => searchStr.includes(k))) {
                    kbKey = key;
                    break;
                }
            }
            const selectedActions = getRandomSubarray(KNOWLEDGE_BASE[kbKey].actions, 2);
            
            const card = document.createElement('div');
            card.className = "mb-4 border-bottom pb-3";
            card.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <span class="pillar-tag me-2">${kbKey}</span>
                    <h6 class="fw-bold mb-0 text-dark">Foco: ${groupedIssues[catName].map(i => i.item).slice(0,2).join(", ")}</h6>
                </div>
                <div class="bg-light p-3 rounded">
                    ${selectedActions.map(action => `<div class="action-step text-secondary small">${action}</div>`).join('')}
                </div>
            `;
            container.appendChild(card);
        });
    }

    function getRandomSubarray(arr, size) {
        var shuffled = arr.slice(0), i = arr.length, min = i - size, temp, index;
        while (i-- > min) {
            index = Math.floor((i + 1) * Math.random());
            temp = shuffled[index];
            shuffled[index] = shuffled[i];
            shuffled[i] = temp;
        }
        return shuffled.slice(min);
    }

    function regeneratePlan() {
        if(GLOBAL_DATA) {
            const btn = document.querySelector('button[onclick="regeneratePlan()"] i');
            btn.classList.add('fa-spin');
            setTimeout(() => {
                generateActionPlan();
                btn.classList.remove('fa-spin');
            }, 400);
        }
    }

    function renderChart(data) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        const catMap = {};
        data.forEach(d => {
            let k = d.category || "Geral";
            k = k.replace("GESTÃO DE ", "").replace("CONHECIMENTO DE ", "");
            if(!catMap[k]) catMap[k] = [];
            catMap[k].push(d.score);
        });
        const labels = Object.keys(catMap);
        const values = labels.map(k => catMap[k].reduce((a,b)=>a+b,0) / catMap[k].length);
        if(window.myRadar) window.myRadar.destroy();
        window.myRadar = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Performance Atual',
                    data: values,
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    pointBackgroundColor: '#2c3e50',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        suggestedMin: 0,
                        suggestedMax: 10,
                        pointLabels: { font: { size: 11 } }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // Bootstrap Dependency
    (function(){
        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js";
        document.body.appendChild(script);
    })();
</script>
</body>
</html>