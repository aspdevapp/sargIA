<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAGE - Sistema de Análise de Gestão Estratégica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #e74c3c;
            --bg-light: #f8f9fa;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #c0392b;
        }
        
        body { background-color: #f4f7f6; font-family: 'Segoe UI', system-ui, sans-serif; color: #333; }
        
        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, #1a252f 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        /* Upload Box */
        .upload-container {
            border: 2px dashed #bdc3c7;
            border-radius: 15px;
            background: white;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-container:hover {
            border-color: var(--primary);
            background: #ecf0f1;
            transform: translateY(-2px);
        }

        /* Cards */
        .kpi-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: none;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 auto 15px;
            border: 8px solid #eee;
        }

        /* Action Plan Styling */
        .action-step {
            position: relative;
            padding-left: 20px;
            margin-bottom: 15px;
            border-left: 3px solid var(--primary);
        }
        .action-step::before {
            content: "•";
            position: absolute;
            left: -16px;
            top: 0px;
            color: var(--primary);
            font-size: 1.5em;
            background: white;
        }

        .pillar-tag {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            padding: 5px 10px;
            border-radius: 4px;
            background: #dfe6e9;
            color: #636e72;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            border-radius: 50px;
            padding: 15px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>

<div class="app-header text-center">
    <div class="container">
        <h1 class="fw-bold"><i class="fas fa-network-wired me-2"></i>SAGE</h1>
        <p class="lead opacity-75 mb-0">Sistema de Análise de Gestão Estratégica & Plano de Ação</p>
    </div>
</div>

<div class="container pb-5">
    
    <div id="uploadSection" class="row justify-content-center">
        <div class="col-md-8">
            <div class="upload-container" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt fa-4x text-muted mb-3"></i>
                <h3 class="fw-bold text-secondary">Carregar Planilha de Diagnóstico</h3>
                <p class="text-muted">Selecione o arquivo .xlsx ou .csv da Roda da Gestão</p>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleFile(this)">
            </div>
            <div class="alert alert-info mt-4 d-flex align-items-center">
                <i class="fas fa-info-circle fs-4 me-3"></i>
                <div>
                    <strong>Dica:</strong> O sistema utiliza a base de conhecimento avançada "Pilares da Gestão" para gerar insights personalizados a cada rodada.
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="kpi-card p-4 text-center h-100">
                    <h6 class="text-uppercase text-muted mb-3">Índice Geral de Gestão</h6>
                    <div id="scoreCircle" class="score-circle">0.0</div>
                    <div id="scoreStatus" class="badge bg-secondary fs-6 px-3 py-2 rounded-pill">Calculando...</div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="kpi-card p-4 h-100 d-flex flex-column justify-content-center">
                    <h5 class="text-muted text-uppercase small fw-bold"><i class="fas fa-user-tag me-2"></i>Perfil Gerencial Identificado</h5>
                    <h2 id="profileTitle" class="fw-bold text-primary mb-2">...</h2>
                    <p id="profileDesc" class="lead fs-6 text-secondary mb-0">...</p>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-5">
                <div class="kpi-card p-4 h-100">
                    <h5 class="fw-bold mb-4">Radar de Competências</h5>
                    <div style="height: 350px; position: relative;">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="kpi-card p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold text-danger"><i class="fas fa-clipboard-list me-2"></i>Plano de Ação Prioritário</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="regeneratePlan()" title="Gerar novas sugestões"><i class="fas fa-sync-alt"></i> Variar Estratégias</button>
                    </div>
                    
                    <div id="actionPlanContainer" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                        </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-1">
            <div class="col-md-6">
                <div class="kpi-card p-4 border-start border-5 border-success">
                    <h6 class="text-success fw-bold text-uppercase"><i class="fas fa-check-circle me-2"></i>Pontos de Destaque</h6>
                    <ul id="strengthsList" class="list-group list-group-flush mt-3"></ul>
                </div>
            </div>
            <div class="col-md-6">
                <div class="kpi-card p-4 border-start border-5 border-danger">
                    <h6 class="text-danger fw-bold text-uppercase"><i class="fas fa-exclamation-triangle me-2"></i>Pontos Críticos</h6>
                    <ul id="weaknessesList" class="list-group list-group-flush mt-3"></ul>
                </div>
            </div>
        </div>
        
        <button class="btn btn-primary refresh-btn" onclick="location.reload()">
            <i class="fas fa-upload me-2"></i>Nova Planilha
        </button>

    </div>
</div>

<script>
    // --- INTELIGÊNCIA ARTIFICIAL: BASE DE CONHECIMENTO ---
    // Extraído e estruturado do documento "PILARES da GESTÃO IA.docx"
    const KNOWLEDGE_BASE = {
        "MERCADO": {
            keywords: ["MERCADO", "CONCORRENTE", "PROPOSTA", "VALOR"],
            actions: [
                "<strong>Mapeamento de Campo:</strong> Vá a campo na região para identificar ramos predominantes e distâncias logísticas reais.",
                "<strong>Análise de Concorrência (SWOT):</strong> Mapeie as ações dos concorrentes diretos e indiretos. Identifique onde eles estão falhando (oportunidade) e onde são fortes (ameaça).",
                "<strong>Visitas Estratégicas:</strong> Visite todos os principais clientes da regional, mapeando não só o atendimento atual, mas as redes de relacionamento deles.",
                "<strong>Parcerias e Polos:</strong> Mapeie polos de negócio e entidades associativas locais para possíveis parcerias de indicação.",
                "<strong>Comunicação de Valor:</strong> Identifique formas de comunicar nossa Proposta de Valor de forma mais simples e objetiva (teste o pitch com um cliente de confiança).",
                "<strong>Ações de Marketing Regional:</strong> Identifique oportunidades para ações de visibilidade local que penetrem onde a marca ainda não chega."
            ]
        },
        "DIRECIONAMENTO": {
            keywords: ["DIRECIONAMENTO", "CLAREZA", "FOCO", "MIX"],
            actions: [
                "<strong>Venda Interna da Visão:</strong> Venda para sua equipe a proposta de valor. Eles precisam comprar a ideia antes de vender para o cliente.",
                "<strong>Mapa da Mina:</strong> Defina claramente quais polos, ramos e clientes específicos devem ser atacados nesta semana. Não deixe a equipe 'escolher' aleatoriamente.",
                "<strong>Clareza de Resultado:</strong> Explique O QUE queremos de resultado e COMO devemos trazê-lo. Evite metas genéricas como 'vender mais'.",
                "<strong>Gestão do Mix:</strong> Controle o mix da carteira para minimizar a dependência de um único ramo ou mercado. Diversificação é segurança.",
                "<strong>Feedback de Rumo:</strong> Mostre onde estamos hoje e onde queremos chegar até o fim do mês. Use recursos visuais.",
                "<strong>Correção Estruturada:</strong> Se os números não vêm, proponha mudanças de rumo regionalmente, mas de forma planejada, não no desespero."
            ]
        },
        "PLANEJAMENTO": {
            keywords: ["PLANEJAMENTO", "AÇÃO", "AGENDA"],
            actions: [
                "<strong>Disciplina Semanal:</strong> Crie uma lista de atividades pessoais e pontos a corrigir com a equipe (Check Point) toda segunda-feira.",
                "<strong>Rituais de Gestão:</strong> Faça o planejamento semanal com a equipe focado nas ações da semana frente aos objetivos do mês.",
                "<strong>Visão Mensal:</strong> Realize uma reunião mensal de 'Status Report' para atualizar todos sobre o gap para o objetivo comum.",
                "<strong>Marketing de Guerrilha:</strong> Identifique oportunidades rápidas e de baixo custo (guerrilha) para alavancar resultados de curto prazo.",
                "<strong>Checagem de Impacto:</strong> Nas reuniões, verifique se as ações planejadas estão gerando impacto no Curto, Médio e Longo prazo. Se não, descarte.",
                "<strong>Mobilização:</strong> Utilize as reuniões não só para cobrar, mas para fortalecer o relacionamento e mobilizar pessoas pelo propósito."
            ]
        },
        "EQUIPE": {
            keywords: ["EQUIPE", "FEEDBACK", "TREINAMENTO", "LIDERANÇA", "ALINHAMENTO"],
            actions: [
                "<strong>Seleção de Perfil:</strong> Revise se as pessoas estão nas cadeiras certas. Selecione profissionais conforme o perfil comportamental para o cargo.",
                "<strong>Investimento em Treino:</strong> Invista tempo real em treinar e capacitar. Não delegue o treinamento apenas para o RH ou plataforma online.",
                "<strong>Correção de Postura:</strong> Atente para detalhes de comportamento, escrita e comunicação da equipe. Corrija desvios imediatamente (feedback regular).",
                "<strong>Reuniões de Sexta:</strong> Utilize as sextas-feiras para simulações (Roleplay) de: Implantação, Prospecção, Abordagem, Negociação e Fechamento.",
                "<strong>Gestão de Processos (POCs/CAPIs):</strong> Utilize os processos para identificar falhas. Analise os CAPIs de cheques e cancelamentos para aprender e corrigir.",
                "<strong>Cobrança com Orientação:</strong> Cobre a meta com firmeza, mas dê a orientação de 'como' chegar lá. Cobrança sem direção gera ansiedade.",
                "<strong>Acompanhamento em Campo:</strong> Acompanhe as equipes em campo para repassar experiência e passar confiança (Liderança pelo Exemplo)."
            ]
        },
        "INOVACAO": {
            keywords: ["INOVAÇÃO", "PROJETOS", "NOVOS", "NEGÓCIOS"],
            actions: [
                "<strong>Testes Práticos:</strong> Teste pessoalmente novos conceitos e metodologias antes de passar para a equipe. Seja o piloto.",
                "<strong>Buy-in da Equipe:</strong> Assegure que as equipes estão entendendo o 'porquê' e a importância das inovações da empresa.",
                "<strong>Feedback de Campo:</strong> Teste novos produtos identificando barreiras iniciais do mercado e traga esse feedback qualificado para a empresa.",
                "<strong>Novos Negócios:</strong> Empenhe-se em desenvolver novas empresas do grupo ou novos negócios, criando relacionamento ativo com o mercado.",
                "<strong>Quebra de Barreiras:</strong> Identifique as dificuldades da equipe em vender o 'novo' e crie scripts ou argumentos para ajudá-los."
            ]
        },
        "INDICADORES": {
            keywords: ["INDICADORES", "DASHBOARD", "NUMEROS", "FUNIL", "CANCELAMENTO", "POS-VENDA"],
            actions: [
                "<strong>Gestão por Números:</strong> Gerencie a regional pelos indicadores do dashboard da CIA. Tenha tolerância zero com falta de dados.",
                "<strong>Foco nas Fases:</strong> Acompanhe o resultado de acordo com as fases da venda (Funil). Onde está o gargalo? Na prospecção ou no fechamento?",
                "<strong>Tratativa de HOTs:</strong> Trate pessoalmente as negociações 'HOT' (quentes/fechamento). Não deixe dinheiro na mesa.",
                "<strong>Análise de Churn:</strong> Entenda e trate os NTIs e aprenda com os cancelamentos. Reduzir a perda é tão importante quanto vender novo.",
                "<strong>Domínio dos Números:</strong> Tenha todos os números da regional em mente. Cobre para que a equipe também saiba seus números de cabeça.",
                "<strong>Ritual de Análise:</strong> Determine um período (ex: Sexta pela manhã) para análise profunda dos dados, primeiro sozinho, depois com a equipe."
            ]
        }
    };

    let GLOBAL_DATA = null;
    let GLOBAL_WEAKNESSES = [];

    function handleFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            processData(jsonData);
        };
        reader.readAsArrayBuffer(file);
    }

    function processData(rows) {
        const extractedData = [];
        let currentCategory = "";

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            let category = row[0]; 
            let item = row[1];
            let scoreRaw = row[2];

            if (!item) continue;
            
            // Tratamento de células mescladas para Categoria
            if (category && typeof category === 'string' && category.trim().length > 2) {
                currentCategory = category.trim();
            } else {
                category = currentCategory;
            }

            if (scoreRaw !== undefined && scoreRaw !== null) {
                let score = parseFloat(scoreRaw);
                if (!isNaN(score) && score >= 0 && score <= 10 && item !== "ITENS AVALIADOS") {
                    extractedData.push({
                        category: category,
                        item: item,
                        score: score
                    });
                }
            }
        }

        if (extractedData.length > 0) {
            GLOBAL_DATA = extractedData;
            renderDashboard(extractedData);
        } else {
            alert("Erro: Não foi possível identificar dados válidos.");
        }
    }

    function renderDashboard(data) {
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';

        // 1. Métricas Gerais
        const totalScore = data.reduce((acc, curr) => acc + curr.score, 0);
        const avg = (totalScore / data.length).toFixed(1);
        
        // Atualiza Círculo de Nota
        const scoreCircle = document.getElementById('scoreCircle');
        scoreCircle.innerText = avg;
        
        let color, status;
        if (avg >= 8) { color = '#27ae60'; status = "Alta Performance"; }
        else if (avg >= 6) { color = '#f39c12'; status = "Em Desenvolvimento"; }
        else { color = '#c0392b'; status = "Crítico"; }
        
        scoreCircle.style.borderColor = color;
        scoreCircle.style.color = color;
        
        const statusBadge = document.getElementById('scoreStatus');
        statusBadge.innerText = status;
        statusBadge.style.backgroundColor = color;

        // 2. Pontos Fortes e Fracos
        const sortedData = [...data].sort((a, b) => a.score - b.score);
        GLOBAL_WEAKNESSES = sortedData.filter(d => d.score < 7);
        const strengths = sortedData.filter(d => d.score >= 8).reverse();

        updateLists(strengths, GLOBAL_WEAKNESSES);
        
        // 3. Perfil
        determineProfile(avg, data);

        // 4. Plano de Ação
        generateActionPlan();

        // 5. Gráfico
        renderChart(data);
    }

    function updateLists(strengths, weaknesses) {
        const createLi = (item, type) => `
            <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                <span>${item.item}</span>
                <span class="fw-bold ${type === 'good' ? 'text-success' : 'text-danger'}">${item.score}</span>
            </li>`;
            
        document.getElementById('strengthsList').innerHTML = strengths.slice(0, 5).map(i => createLi(i, 'good')).join('');
        document.getElementById('weaknessesList').innerHTML = weaknesses.slice(0, 5).map(i => createLi(i, 'bad')).join('') || '<li class="text-muted">Nenhum ponto crítico detectado.</li>';
    }

    // Função Principal para gerar o Plano de Ação Dinâmico
    function generateActionPlan() {
        const container = document.getElementById('actionPlanContainer');
        container.innerHTML = "";

        // Identifica quais pilares precisam de atenção
        // Prioridade: Itens com nota < 7. Se não houver, pega os 3 menores scores gerais.
        let targetItems = GLOBAL_WEAKNESSES.length > 0 ? GLOBAL_WEAKNESSES : GLOBAL_DATA.sort((a,b) => a.score - b.score).slice(0, 3);
        
        // Agrupar itens por Categoria para evitar repetição
        const groupedIssues = {};
        targetItems.forEach(item => {
            const cat = item.category || "GERAL";
            if (!groupedIssues[cat]) groupedIssues[cat] = [];
            groupedIssues[cat].push(item);
        });

        // Para cada categoria problemática, buscar conselhos
        Object.keys(groupedIssues).forEach(catName => {
            // Encontrar a chave correspondente na Knowledge Base
            let kbKey = null;
            // Busca inteligente por palavra-chave
            const searchStr = (catName + " " + groupedIssues[catName][0].item).toUpperCase();
            
            for (const key in KNOWLEDGE_BASE) {
                if (KNOWLEDGE_BASE[key].keywords.some(k => searchStr.includes(k))) {
                    kbKey = key;
                    break;
                }
            }
            
            // Fallback para "DIRECIONAMENTO" se não achar
            if (!kbKey) kbKey = "DIRECIONAMENTO"; 

            const kbData = KNOWLEDGE_BASE[kbKey];
            
            // Seleciona 2 ou 3 ações ALEATÓRIAS da lista para garantir variedade
            const selectedActions = getRandomSubarray(kbData.actions, 2);

            // Monta o HTML do Card
            const card = document.createElement('div');
            card.className = "mb-4 border-bottom pb-3";
            card.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <span class="pillar-tag me-2">${kbKey}</span>
                    <h6 class="fw-bold mb-0 text-dark">Foco: ${groupedIssues[catName].map(i => i.item).slice(0,2).join(", ")}</h6>
                </div>
                <div class="bg-light p-3 rounded">
                    ${selectedActions.map(action => `<div class="action-step text-secondary small">${action}</div>`).join('')}
                </div>
            `;
            container.appendChild(card);
        });

        if (container.innerHTML === "") {
            container.innerHTML = "<div class='text-center text-muted py-4'>Sua gestão está equilibrada. Foque em manter os rituais atuais.</div>";
        }
    }

    // Função auxiliar para embaralhar e pegar N itens (Fisher-Yates Shuffle simplificado)
    function getRandomSubarray(arr, size) {
        var shuffled = arr.slice(0), i = arr.length, min = i - size, temp, index;
        while (i-- > min) {
            index = Math.floor((i + 1) * Math.random());
            temp = shuffled[index];
            shuffled[index] = shuffled[i];
            shuffled[i] = temp;
        }
        return shuffled.slice(min);
    }

    function regeneratePlan() {
        if(GLOBAL_DATA) {
            const btn = document.querySelector('button[onclick="regeneratePlan()"] i');
            btn.classList.add('fa-spin');
            setTimeout(() => {
                generateActionPlan(); // Vai pegar novas ações aleatórias
                btn.classList.remove('fa-spin');
            }, 400);
        }
    }

    function determineProfile(avg, data) {
        // Lógica de Perfil
        const getScore = (key) => {
            const items = data.filter(d => (d.category + d.item).toUpperCase().includes(key));
            return items.length ? items.reduce((a,b)=>a+b.score,0)/items.length : 0;
        };

        const people = getScore("EQUIPE");
        const process = getScore("INDICADORES") + getScore("PROCESSOS");
        
        let title = "Gestor em Desenvolvimento";
        let desc = "Você está construindo as bases. Foque em estabilizar os processos básicos.";

        if (avg >= 8.5) {
            title = "Gestor Estrategista";
            desc = "Alta performance. Seu foco deve mudar da operação para a inovação e formação de sucessores.";
        } else if (people > process && people > 7) {
            title = "Líder de Pessoas";
            desc = "Forte conexão humana, mas pode estar negligenciando os números frios. Equilibre com gestão à vista.";
        } else if (process > people && process > 7) {
            title = "Gestor Executor";
            desc = "Entrega resultados e domina o funil, mas precisa cuidar para não microgerenciar ou desmotivar o time.";
        }

        document.getElementById('profileTitle').innerText = title;
        document.getElementById('profileDesc').innerText = desc;
    }

    function renderChart(data) {
        // Agrupar por Categoria
        const catMap = {};
        data.forEach(d => {
            let k = d.category || "Geral";
            // Limpar nomes longos de categoria para o gráfico
            k = k.replace("GESTÃO DE ", "").replace("CONHECIMENTO DE ", "");
            if(!catMap[k]) catMap[k] = [];
            catMap[k].push(d.score);
        });

        const labels = Object.keys(catMap);
        const values = labels.map(k => catMap[k].reduce((a,b)=>a+b,0) / catMap[k].length);

        const ctx = document.getElementById('radarChart').getContext('2d');
        
        // Destruir gráfico anterior se existir (para evitar sobreposição no reload)
        if(window.myRadar) window.myRadar.destroy();

        window.myRadar = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Performance Atual',
                    data: values,
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    pointBackgroundColor: '#2c3e50',
                    pointBorderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { color: '#ecf0f1' },
                        grid: { color: '#ecf0f1' },
                        pointLabels: {
                            font: { size: 11, family: 'Segoe UI' },
                            color: '#7f8c8d'
                        },
                        suggestedMin: 0,
                        suggestedMax: 10
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }
</script>

</body>
</html>
